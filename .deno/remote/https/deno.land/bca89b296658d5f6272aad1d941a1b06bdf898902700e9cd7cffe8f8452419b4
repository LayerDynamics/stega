import { GenericPrompt } from "./_generic_prompt.ts";
import { underline } from "./deps.ts";
import {
  GenericInput,
  GenericInputKeys,
  GenericInputPromptOptions,
  GenericInputPromptSettings,
} from "./_generic_input.ts";

/** Secret prompt options. */
export interface SecretOptions
  extends GenericInputPromptOptions<string, string> {
  keys?: SecretKeys;
  /** Change prompt label. Default is `Secret`. */
  label?: string;
  /**
   * If enabled, the input value is hidden, otherwise each character is replaced
   * with a `*`.
   */
  hidden?: boolean;
  /** Limit minimum allowed length of the secret. */
  minLength?: number;
  /** Limit maximum allowed length of the secret. */
  maxLength?: number;
}

/** Secret prompt settings. */
interface SecretSettings extends GenericInputPromptSettings<string, string> {
  label: string;
  hidden: boolean;
  minLength: number;
  maxLength: number;
  keys?: SecretKeys;
}

/** Secret prompt keymap. */
export type SecretKeys = GenericInputKeys;

/**
 * Secret prompt representation.
 *
 * ```ts
 * import { Secret } from "./mod.ts";
 *
 * const password: string = await Secret.prompt("Enter your password");
 * ```
 */
export class Secret extends GenericInput<string, string> {
  protected readonly settings: SecretSettings;

  /** Execute the prompt with provided message or options. */
  public static prompt(options: string | SecretOptions): Promise<string> {
    return new this(options).prompt();
  }

  /**
   * Inject prompt value. If called, the prompt doesn't prompt for an input and
   * returns immediately the injected value. Can be used for unit tests or pre
   * selections.
   *
   * @param value Input value.
   */
  public static inject(value: string): void {
    GenericPrompt.inject(value);
  }

  constructor(options: string | SecretOptions) {
    super();
    if (typeof options === "string") {
      options = { message: options };
    }
    this.settings = this.getDefaultSettings(options);
  }

  public getDefaultSettings(options: SecretOptions): SecretSettings {
    return {
      ...super.getDefaultSettings(options),
      label: options.label ?? "Secret",
      hidden: options.hidden ?? false,
      minLength: options.minLength ?? 0,
      maxLength: options.maxLength ?? Infinity,
    };
  }

  protected input(): string {
    return underline(
      this.settings.hidden ? "" : "*".repeat(this.inputValue.length),
    );
  }

  /** Read user input. */
  protected read(): Promise<boolean> {
    if (this.settings.hidden) {
      this.settings.tty.cursorHide();
    }
    return super.read();
  }

  /**
   * Validate input value.
   * @param value User input value.
   * @return True on success, false or error message on error.
   */
  protected validate(value: string): boolean | string {
    if (typeof value !== "string") {
      return false;
    }
    if (value.length < this.settings.minLength) {
      return `${this.settings.label} must be longer than ${this.settings.minLength} but has a length of ${value.length}.`;
    }
    if (value.length > this.settings.maxLength) {
      return `${this.settings.label} can't be longer than ${this.settings.maxLength} but has a length of ${value.length}.`;
    }
    return true;
  }

  /**
   * Map input value to output value.
   * @param value Input value.
   * @return Output value.
   */
  protected transform(value: string): string | undefined {
    return value;
  }

  /**
   * Format output value.
   * @param value Output value.
   */
  protected format(value: string): string {
    return this.settings.hidden ? "*".repeat(8) : "*".repeat(value.length);
  }

  /** Get input input. */
  protected getValue(): string {
    return this.inputValue;
  }
}

// denoCacheMetadata={"headers":{"x-amz-server-side-encryption":"AES256","referrer-policy":"strict-origin-when-cross-origin","x-amz-version-id":"tGw7fTdH.AGJkAdgKROLGYxgDiMVDeLc","cross-origin-embedder-policy":"same-origin","via":"http/2 edgeproxy-h","etag":"\"9c661ba37db166b8cc32c68d655ebdd7\"","x-amz-cf-pop":"IAD12-P5","last-modified":"Sun, 30 Jul 2023 10:00:26 GMT","cross-origin-resource-policy":"same-origin","accept-ranges":"bytes","access-control-allow-origin":"*","content-type":"application/typescript; charset=utf-8","server":"deno/gcp-us-east4","x-amz-replication-status":"COMPLETED","server-timing":"fetchSource;dur=18","cross-origin-opener-policy":"same-origin","x-cache":"Hit from cloudfront","x-frame-options":"DENY","x-content-type-options":"nosniff","strict-transport-security":"max-age=63072000; includeSubDomains; preload","cache-control":"public, max-age=31536000, immutable","content-length":"3701","age":"111820","content-security-policy":"default-src 'none'; style-src 'unsafe-inline'; sandbox","date":"Mon, 13 Jan 2025 04:05:25 GMT","vary":"Accept-Encoding, Origin","x-amz-cf-id":"u0HUeNlzF8AdnI3pMEvMKDCgdH-12E9sXkJeZ2QDf9NiRpunvnJJlg=="},"url":"https://deno.land/x/cliffy@v1.0.0-rc.3/prompt/secret.ts","time":1736852944}